version: "3.9"

services:
  certs:
    image: alpine:3
    container_name: proxclient-certs
    command: >-
      sh -c "set -euo pipefail;
      apk add --no-cache openssl >/dev/null;
      mkdir -p /out;
      if [ ! -f /out/cert.pem ] || [ ! -f /out/key.pem ]; then
        echo 'Generating self-signed certificate...';
        openssl req -x509 -newkey rsa:2048 -nodes -keyout /out/key.pem -out /out/cert.pem -days 365 -subj '/CN=localhost';
      else
        echo 'Existing certs found in volume, skipping generation.';
      fi"
    volumes:
      - certs:/out
    restart: "no"

  proxclient:
    build:
      context: .
      dockerfile: Dockerfile
    image: proxclient:local
    container_name: proxclient
    environment:
      # App listens on plain HTTP 8080 inside container
      - PORT=8080
      - PROXMOX_HOST=${PROXMOX_HOST:-arlsouth4.utep.edu}
      - PROXMOX_PORT=${PROXMOX_PORT:-8006}
      - PROXMOX_REALM=${PROXMOX_REALM:-pam}
      - VERIFY_SSL=${VERIFY_SSL:-false}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-change-me-now}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG_HTTP=${DEBUG_HTTP:-false}
  # NOTE: Removed extra_hosts override that mapped PROXMOX_HOST to "host-gateway".
  # On Docker Desktop (macOS/Windows) the special token 'host-gateway' may not resolve,
  # producing "Temporary failure in name resolution" when Python tries to resolve the host.
  # If you actually need to override DNS (e.g. internal LAN name), uncomment and set an IP:
  # extra_hosts:
  #   - "${PROXMOX_HOST}:192.168.1.10"   # Replace with real Proxmox IP
    # Bind app only on loopback so nginx (host network) can reach it, not exposed externally
    ports:
      - "127.0.0.1:8080:8080"
    # Note: TLS termination should be handled by a reverse proxy (e.g. nginx) â€” waitress doesn't serve HTTPS.
    restart: unless-stopped
  # If Proxmox is only bound to 127.0.0.1 or a host-only interface, consider host networking instead:
  # network_mode: host
  # (remove ports when using host networking)

  nginx-proxmox:
    image: nginx:stable-alpine
    container_name: proxclient-nginx-proxmox
    depends_on:
      certs:
        condition: service_completed_successfully
    volumes:
      - certs:/etc/nginx/certs:ro
      # Mount only the server snippet (default nginx.conf in image stays intact)
      - ./deploy/proxmox.conf:/etc/nginx/conf.d/proxmox.conf:ro
    # Use host networking so proxy can reach localhost:8006 and localhost:8080 reliably
    network_mode: host
    restart: unless-stopped

volumes:
  certs:
